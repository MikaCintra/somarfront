<div class="marketplace-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>ğŸ›’ Marketplace de DoaÃ§Ãµes</h1>
      <p class="subtitle">Conecte necessidades com doadores</p>
    </div>
    <div class="header-actions">
      <app-theme-language-toggle></app-theme-language-toggle>
      <button *ngIf="isONG" class="btn-primary" (click)="openAddItemModal()">
        <span>â•</span> Adicionar Necessidade
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button 
      class="tab" 
      [class.active]="activeTab === 'available'"
      (click)="activeTab = 'available'">
      ğŸ“¦ Itens DisponÃ­veis
      <span class="badge">{{ availableItems.length }}</span>
    </button>
    <button 
      *ngIf="isONG"
      class="tab" 
      [class.active]="activeTab === 'wishlist'"
      (click)="activeTab = 'wishlist'">
      â­ Minhas Necessidades
      <span class="badge">{{ myWishlist.length }}</span>
    </button>
    <button 
      *ngIf="!isONG"
      class="tab" 
      [class.active]="activeTab === 'reservations'"
      (click)="activeTab = 'reservations'">
      ğŸ¯ Minhas Reservas
      <span class="badge">{{ myReservations.length }}</span>
    </button>
  </div>

  <!-- Filters -->
  <div class="filters" *ngIf="activeTab === 'available'">
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="searchTerm"
        (input)="onSearch()"
        placeholder="ğŸ” Buscar itens..."
        class="search-input">
    </div>
    
    <select [(ngModel)]="selectedCategory" (change)="onFilterChange()" class="filter-select">
      <option *ngFor="let cat of categories" [value]="cat.value">
        {{ cat.icon }} {{ cat.label }}
      </option>
    </select>
    
    <select [(ngModel)]="selectedUrgency" (change)="onFilterChange()" class="filter-select">
      <option *ngFor="let urg of urgencyLevels" [value]="urg.value">
        {{ urg.label }}
      </option>
    </select>
    
    <select [(ngModel)]="selectedCondition" (change)="onFilterChange()" class="filter-select">
      <option *ngFor="let cond of conditions" [value]="cond.value">
        {{ cond.icon }} {{ cond.label }}
      </option>
    </select>
  </div>

  <!-- Available Items -->
  <div class="content-area" *ngIf="activeTab === 'available'">
    <div class="items-grid" *ngIf="availableItems.length > 0">
      <div class="item-card" *ngFor="let item of availableItems">
        <div class="item-header">
          <span class="category-icon">{{ getCategoryIcon(item.category) }}</span>
          <span class="urgency-badge" [style.background]="getUrgencyColor(item.urgency)">
            {{ item.urgency === 'high' ? 'Alta' : item.urgency === 'medium' ? 'MÃ©dia' : 'Baixa' }}
          </span>
        </div>
        
        <h3 class="item-name">{{ item.title }}</h3>
        <p class="item-description">{{ item.description }}</p>
        
        <div class="item-details">
          <div class="detail-row">
            <span class="label">Quantidade:</span>
            <span class="value">{{ item.quantity }}</span>
          </div>
          <div class="detail-row">
            <span class="label">CondiÃ§Ã£o:</span>
            <span class="value">{{ getConditionIcon(item.condition) }} 
              {{ item.condition === 'new' ? 'Novo' : item.condition === 'used' ? 'Usado' : 'Qualquer' }}
            </span>
          </div>
          <div class="detail-row">
            <span class="label">Solicitado por:</span>
            <span class="value">{{ item.ongName }}</span>
          </div>
        </div>
        
        <button 
          *ngIf="!isONG && item.status === 'available'"
          class="btn-reserve" 
          (click)="reserveItem(item)">
          ğŸ¯ Reservar Item
        </button>
        
        <div class="status-badge reserved" *ngIf="item.status === 'reserved'">
          â³ Reservado
        </div>
        <div class="status-badge matched" *ngIf="item.status === 'fulfilled'">
          âœ… Doado
        </div>
      </div>
    </div>
    
    <div class="empty-state" *ngIf="availableItems.length === 0">
      <span class="empty-icon">ğŸ“­</span>
      <h3>Nenhum item disponÃ­vel</h3>
      <p>Tente ajustar os filtros ou volte mais tarde</p>
    </div>
  </div>

  <!-- Wishlist (ONG) -->
  <div class="content-area" *ngIf="activeTab === 'wishlist' && isONG">
    <div class="items-grid" *ngIf="myWishlist.length > 0">
      <div class="item-card wishlist-card" *ngFor="let item of myWishlist">
        <div class="item-header">
          <span class="category-icon">{{ getCategoryIcon(item.category) }}</span>
          <span class="urgency-badge" [style.background]="getUrgencyColor(item.urgency)">
            {{ item.urgency === 'high' ? 'Alta' : item.urgency === 'medium' ? 'MÃ©dia' : 'Baixa' }}
          </span>
        </div>
        
        <h3 class="item-name">{{ item.title }}</h3>
        <p class="item-description">{{ item.description }}</p>
        
        <div class="item-details">
          <div class="detail-row">
            <span class="label">Quantidade:</span>
            <span class="value">{{ item.quantity }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Status:</span>
            <span class="value status-{{ item.status }}">
              {{ item.status === 'available' ? 'ğŸŸ¢ Aguardando' : item.status === 'reserved' ? 'ğŸŸ¡ Reservado' : 'âœ… Recebido' }}
            </span>
          </div>
        </div>
        
        <div class="card-actions">
          <button class="btn-secondary" (click)="viewMatches(item)">
            ğŸ‘¥ Ver CorrespondÃªncias
          </button>
          <button class="btn-danger" (click)="removeFromWishlist(item)">
            ğŸ—‘ï¸ Remover
          </button>
        </div>
      </div>
    </div>
    
    <div class="empty-state" *ngIf="myWishlist.length === 0">
      <span class="empty-icon">â­</span>
      <h3>Nenhuma necessidade cadastrada</h3>
      <p>Adicione itens que sua ONG precisa receber</p>
      <button class="btn-primary" (click)="openAddItemModal()">
        â• Adicionar Necessidade
      </button>
    </div>
  </div>

  <!-- Reservations (Donor) -->
  <div class="content-area" *ngIf="activeTab === 'reservations' && !isONG">
    <div class="reservations-list" *ngIf="myReservations.length > 0">
      <div class="reservation-card" *ngFor="let reservation of myReservations">
        <div class="reservation-header">
          <div>
            <h3>{{ reservation.itemName }}</h3>
            <p class="ong-name">Para: {{ reservation.ongName }}</p>
          </div>
          <span class="status-badge" [class]="reservation.status">
            {{ reservation.status === 'pending' ? 'â³ Pendente' : 
               reservation.status === 'completed' ? 'âœ… ConcluÃ­do' : 
               'âŒ Cancelado' }}
          </span>
        </div>
        
        <div class="reservation-details">
          <div class="detail-item">
            <span class="icon">ğŸ“…</span>
            <div>
              <strong>Reservado em:</strong>
              <p>{{ reservation.reservedAt | date: 'dd/MM/yyyy HH:mm' }}</p>
            </div>
          </div>
          
          <div class="detail-item" *ngIf="reservation.status === 'pending' && reservation.expiresAt">
            <span class="icon">â°</span>
            <div>
              <strong>Expira em:</strong>
              <p class="time-remaining">{{ getTimeRemaining(reservation.expiresAt!) }}</p>
            </div>
          </div>
          
          <div class="detail-item" *ngIf="reservation.completedAt">
            <span class="icon">âœ…</span>
            <div>
              <strong>ConcluÃ­do em:</strong>
              <p>{{ reservation.completedAt | date: 'dd/MM/yyyy HH:mm' }}</p>
            </div>
          </div>
        </div>
        
        <div class="reservation-actions" *ngIf="reservation.status === 'pending'">
          <button class="btn-success" (click)="completeReservation(reservation)">
            âœ… Marcar como Doado
          </button>
          <button class="btn-danger-outline" (click)="cancelReservation(reservation)">
            âŒ Cancelar
          </button>
        </div>
      </div>
    </div>
    
    <div class="empty-state" *ngIf="myReservations.length === 0">
      <span class="empty-icon">ğŸ¯</span>
      <h3>Nenhuma reserva ativa</h3>
      <p>Reserve itens para ajudar ONGs necessitadas</p>
      <button class="btn-primary" (click)="activeTab = 'available'">
        ğŸ“¦ Ver Itens DisponÃ­veis
      </button>
    </div>
  </div>
</div>

<!-- Add Item Modal -->
<div class="modal-overlay" *ngIf="showAddItemModal" (click)="closeAddItemModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>â• Adicionar Necessidade</h2>
      <button class="close-btn" (click)="closeAddItemModal()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label>Nome do Item *</label>
        <input type="text" [(ngModel)]="newItem.title" placeholder="Ex: Cestas BÃ¡sicas" class="form-input">
      </div>
      
      <div class="form-group">
        <label>DescriÃ§Ã£o *</label>
        <textarea [(ngModel)]="newItem.description" rows="3" placeholder="Descreva o item e sua importÃ¢ncia..." class="form-textarea"></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Categoria *</label>
          <select [(ngModel)]="newItem.category" class="form-select">
            <option *ngFor="let cat of categories.slice(1)" [value]="cat.value">
              {{ cat.icon }} {{ cat.label }}
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label>UrgÃªncia *</label>
          <select [(ngModel)]="newItem.urgency" class="form-select">
            <option *ngFor="let urg of urgencyLevels.slice(1)" [value]="urg.value">
              {{ urg.label }}
            </option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>CondiÃ§Ã£o Aceita *</label>
          <select [(ngModel)]="newItem.condition" class="form-select">
            <option *ngFor="let cond of conditions.slice(1)" [value]="cond.value">
              {{ cond.icon }} {{ cond.label }}
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Quantidade *</label>
          <input type="number" [(ngModel)]="newItem.quantity" min="1" class="form-input">
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeAddItemModal()">Cancelar</button>
      <button class="btn-primary" (click)="addItemToWishlist()">â• Adicionar</button>
    </div>
  </div>
</div>

<!-- Match Modal -->
<div class="modal-overlay" *ngIf="showMatchModal" (click)="closeMatchModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ğŸ‘¥ CorrespondÃªncias Potenciais</h2>
      <button class="close-btn" (click)="closeMatchModal()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <div class="match-info" *ngIf="selectedItem">
        <h3>{{ selectedItem.title }}</h3>
        <p>{{ selectedItem.description }}</p>
      </div>
      
      <div class="matches-list">
        <div class="match-item">
          <div class="match-score">
            <div class="score-circle">95%</div>
            <span>Match</span>
          </div>
          <div class="match-details">
            <h4>JoÃ£o Silva</h4>
            <p>Doou 15 vezes â€¢ â­ 4.9</p>
            <p class="match-reason">âœ… HistÃ³rico com esta categoria</p>
          </div>
        </div>
        
        <div class="match-item">
          <div class="match-score">
            <div class="score-circle">87%</div>
            <span>Match</span>
          </div>
          <div class="match-details">
            <h4>Maria Santos</h4>
            <p>Doou 8 vezes â€¢ â­ 5.0</p>
            <p class="match-reason">âœ… PrÃ³xima da sua regiÃ£o</p>
          </div>
        </div>
        
        <p class="info-text">ğŸ’¡ Doadores serÃ£o notificados automaticamente sobre esta necessidade</p>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn-primary" (click)="closeMatchModal()">Fechar</button>
    </div>
  </div>
</div>
